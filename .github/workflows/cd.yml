name: Beanstalk CD Deploy

on:

  workflow_run:

    workflows: ["Backend CI"]

    types:

      - completed

    branches:

      - master

      - release-*

  workflow_dispatch:

jobs:

  deploy:

    if: >

      github.event.workflow_run.conclusion == 'success' &&

      startsWith(github.event.workflow_run.head_branch, 'release-')

    runs-on: ubuntu-latest

    steps:

      - name: Checkout code

        uses: actions/checkout@v4

      - name: Read Java version from Gradle

        id: java_version

        run: |

          JAVA_VERSION=$(grep -oP 'JavaLanguageVersion.of\(\K[0-9]+' questevent-backend/build.gradle)

          if [ -z "$JAVA_VERSION" ]; then

            echo "Java version not found"

            exit 1

          fi

          echo "java=$JAVA_VERSION" >> $GITHUB_OUTPUT

      - name: Set up Java

        uses: actions/setup-java@v4

        with:

          distribution: temurin

          java-version: ${{ steps.java_version.outputs.java }}

          cache: gradle

      - name: Make Gradle wrapper executable

        run: chmod +x questevent-backend/gradlew

      - name: Build JAR

        working-directory: questevent-backend

        run: ./gradlew bootJar -x test

      - name: Generate Version Label

        run: |

          echo "VERSION_LABEL=questevent-${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      - name: Configure AWS credentials

        uses: aws-actions/configure-aws-credentials@v3

        with:

          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}

          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload JAR to S3

        working-directory: questevent-backend

        run: |

          JAR_FILE=$(ls build/libs/*.jar | head -n 1)

          aws s3 cp "$JAR_FILE" s3://questevent-versions/${VERSION_LABEL}.jar

      - name: Create Beanstalk Application Version

        run: |

          aws elasticbeanstalk create-application-version \

            --application-name "QuestEventTest" \

            --version-label "$VERSION_LABEL" \

            --source-bundle S3Bucket="questevent-versions",S3Key="${VERSION_LABEL}.jar" \

            --process

      - name: Wait for Beanstalk Version to be PROCESSED

        run: |

          echo "Waiting for application version ${VERSION_LABEL} to be processed..."

          MAX_ATTEMPTS=60

          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do

            # Get the status with better error handling

            STATUS=$(aws elasticbeanstalk describe-application-versions \

              --application-name "QuestEventTest" \

              --version-labels "$VERSION_LABEL" \

              --query "ApplicationVersions[0].Status" \

              --output text 2>&1)

            EXIT_CODE=$?

            if [ $EXIT_CODE -ne 0 ]; then

              echo "Error querying application version: $STATUS"

              sleep 10

              ATTEMPT=$((ATTEMPT + 1))

              continue

            fi

            echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS - Current status: $STATUS"

            if [ "$STATUS" = "PROCESSED" ]; then

              echo "✓ Version processed successfully!"

              # Add a small buffer to ensure it's fully ready

              echo "Waiting 5 additional seconds to ensure readiness..."

              sleep 5

              break

            elif [ "$STATUS" = "FAILED" ]; then

              echo "✗ Application version processing failed!"

              exit 1

            elif [ "$STATUS" = "None" ] || [ -z "$STATUS" ]; then

              echo "⚠ Application version not found yet"

            else

              echo "⏳ Still processing..."

            fi

            sleep 10

            ATTEMPT=$((ATTEMPT + 1))

          done

          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then

            echo "✗ Timeout waiting for application version to be processed"

            exit 1

          fi

      - name: Deploy to Elastic Beanstalk

        run: |

          echo "Deploying ${VERSION_LABEL} to environment QuestEventuTest-env..."

          aws elasticbeanstalk update-environment \

            --application-name "QuestEventTest" \

            --environment-name "QuestEventuTest-env" \

            --version-label "$VERSION_LABEL"

          echo "✓ Deployment initiated successfully!"

      - name: Wait for Environment Update (Optional)

        run: |

          echo "Monitoring environment update..."

          MAX_ATTEMPTS=60

          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do

            ENV_STATUS=$(aws elasticbeanstalk describe-environments \

              --application-name "QuestEventTest" \

              --environment-names "QuestEventuTest-env" \

              --query "Environments[0].Status" \

              --output text)

            HEALTH=$(aws elasticbeanstalk describe-environments \

              --application-name "QuestEventTest" \

              --environment-names "QuestEventuTest-env" \

              --query "Environments[0].Health" \

              --output text)

            echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS - Status: $ENV_STATUS, Health: $HEALTH"

            if [ "$ENV_STATUS" = "Ready" ]; then

              echo "✓ Environment is ready!"

              if [ "$HEALTH" = "Green" ]; then

                echo "✓ Environment health is Green!"

                exit 0

              elif [ "$HEALTH" = "Yellow" ]; then

                echo "⚠ Environment health is Yellow (degraded but functional)"

                exit 0

              else

                echo "⚠ Environment health is $HEALTH"

                exit 0

              fi

            elif [ "$ENV_STATUS" = "Terminated" ]; then

              echo "✗ Environment was terminated!"

              exit 1

            fi

            sleep 15

            ATTEMPT=$((ATTEMPT + 1))

          done

          echo "⚠ Deployment monitoring timeout - check AWS console for final status"
