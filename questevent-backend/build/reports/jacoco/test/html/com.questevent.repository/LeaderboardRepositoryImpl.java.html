<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LeaderboardRepositoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">questevent-backend</a> &gt; <a href="index.source.html" class="el_package">com.questevent.repository</a> &gt; <span class="el_source">LeaderboardRepositoryImpl.java</span></div><h1>LeaderboardRepositoryImpl.java</h1><pre class="source lang-java linenums">package com.questevent.repository;

import com.questevent.dto.LeaderboardDTO;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.UUID;

@Repository
<span class="fc" id="L12">public class LeaderboardRepositoryImpl implements LeaderboardRepository {</span>

    @PersistenceContext
    private EntityManager em;

    @Override
    public List&lt;LeaderboardDTO&gt; getGlobalLeaderboard() {
<span class="nc" id="L19">        return em.createQuery(&quot;&quot;&quot;</span>
            SELECT new com.questevent.dto.LeaderboardDTO(
                u.userId,
                u.name,

                /* completedActivitiesCount */
                COUNT(DISTINCT CASE
                    WHEN s.reviewStatus = com.questevent.enums.ReviewStatus.APPROVED
                    THEN s.activityRegistration.activity.activityId
                END),

                /* gems (FORCE Long) */
                (w.gems * 1L),

                /* score (FORCE Double / BigDecimal-safe) */
                COALESCE(
                    (
                        0.5 * (
                            COUNT(DISTINCT CASE
                                WHEN s.reviewStatus = com.questevent.enums.ReviewStatus.APPROVED
                                THEN s.activityRegistration.activity.activityId
                            END) * 1.0
                        )
                        /
                        NULLIF(COUNT(DISTINCT ar.activity.activityId), 0)
                        * 100
                    )
                    + 0.3 * COUNT(DISTINCT CASE
                        WHEN s.reviewStatus = com.questevent.enums.ReviewStatus.APPROVED
                        THEN s.activityRegistration.activity.activityId
                    END)
                    + 0.2 * (w.gems * 1.0),
                    0.0
                )
            )
            FROM User u
            JOIN u.wallet w
            LEFT JOIN ActivityRegistration ar
                ON ar.user.userId = u.userId
            LEFT JOIN ActivitySubmission s
                ON s.activityRegistration.activityRegistrationId = ar.activityRegistrationId
            GROUP BY u.userId, u.name, w.gems
            ORDER BY 5 DESC
<span class="nc" id="L62">        &quot;&quot;&quot;, LeaderboardDTO.class).getResultList();</span>
    }

    @Override
    public List&lt;LeaderboardDTO&gt; getProgramLeaderboard(UUID programId) {
<span class="nc" id="L67">        return em.createQuery(&quot;&quot;&quot;</span>
            SELECT new com.questevent.dto.LeaderboardDTO(
                pw.user.userId,
                pw.user.name,

                /* completedActivitiesCount */
                COUNT(DISTINCT CASE
                    WHEN s.reviewStatus = com.questevent.enums.ReviewStatus.APPROVED
                    THEN s.activityRegistration.activity.activityId
                END),

                /* program gems (FORCE Long) */
                (pw.gems * 1L),

                /* program score */
                (
                    0.5 * COUNT(DISTINCT CASE
                        WHEN s.reviewStatus = com.questevent.enums.ReviewStatus.APPROVED
                        THEN s.activityRegistration.activity.activityId
                    END)
                    + 0.5 * (pw.gems * 1.0)
                )
            )
            FROM ProgramWallet pw
            LEFT JOIN ActivityRegistration ar
                ON ar.user.userId = pw.user.userId
                AND ar.activity.program.programId = :programId
            LEFT JOIN ActivitySubmission s
                ON s.activityRegistration.activityRegistrationId = ar.activityRegistrationId
            WHERE pw.program.programId = :programId
            GROUP BY pw.user.userId, pw.user.name, pw.gems
            ORDER BY 5 DESC
        &quot;&quot;&quot;, LeaderboardDTO.class)
<span class="nc" id="L100">                .setParameter(&quot;programId&quot;, programId)</span>
<span class="nc" id="L101">                .getResultList();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>