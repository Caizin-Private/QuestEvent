<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QuestEvent (Local)</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        #user-section {
            display: none;
        }
        pre {
            background: #f4f4f4;
            padding: 12px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        button {
            margin-right: 8px;
            padding: 8px 12px;
        }
    </style>
</head>
<body>

<h1>QuestEvent (Local)</h1>

<div id="login-section">
    <button id="loginBtn">Login with Microsoft</button>
</div>

<div id="user-section">
    <h2>Welcome, <span id="user-name"></span>!</h2>
    <button id="apiBtn">Test API</button>
    <button id="logoutBtn">Logout</button>
    <div id="api-result"></div>
</div>

<!-- MSAL -->
<script src="/js/msal-browser.min.js"></script>

<script>
    /* =========================================================
       MSAL CONFIG
       ========================================================= */

    const msalConfig = {
        auth: {
            clientId: "8dfa7db6-153c-4137-91c7-4262f361c8c6",
            authority: "https://login.microsoftonline.com/f7b92ef4-239a-49ad-aff6-679ec33dea08",
            redirectUri: "http://localhost:8080"
        },
        cache: {
            cacheLocation: "sessionStorage",
            storeAuthStateInCookie: false
        }
    };

    // BACKEND SCOPE
    const API_SCOPE = "api://8dfa7db6-153c-4137-91c7-4262f361c8c6/access_as_user";

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    /* =========================================================
       ELEMENTS
       ========================================================= */

    const loginSection = document.getElementById("login-section");
    const userSection  = document.getElementById("user-section");
    const userName     = document.getElementById("user-name");
    const apiResult    = document.getElementById("api-result");

    const loginBtn  = document.getElementById("loginBtn");
    const apiBtn    = document.getElementById("apiBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    /* =========================================================
       INIT
       ========================================================= */

    async function init() {
        await msalInstance.initialize();

        const redirectResult = await msalInstance.handleRedirectPromise();

        if (redirectResult?.account) {
            msalInstance.setActiveAccount(redirectResult.account);
        }

        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0 && !msalInstance.getActiveAccount()) {
            msalInstance.setActiveAccount(accounts[0]);
        }

        const account = msalInstance.getActiveAccount();
        account ? showLoggedIn(account) : showLoggedOut();
    }

    init();

    /* =========================================================
       UI HELPERS
       ========================================================= */

    function showLoggedIn(account) {
        loginSection.style.display = "none";
        userSection.style.display = "block";
        userName.textContent = account.name || account.username;
    }

    function showLoggedOut() {
        loginSection.style.display = "block";
        userSection.style.display = "none";
    }

    /* =========================================================
       LOGIN
       ========================================================= */

    loginBtn.onclick = () => {
        msalInstance.loginRedirect({
            scopes: ["openid", "profile", API_SCOPE]
        });
    };

    /* =========================================================
       API CALL
       ========================================================= */

    apiBtn.onclick = async () => {
        apiResult.innerHTML = "Calling API...";

        const account = msalInstance.getActiveAccount();
        if (!account) {
            apiResult.innerHTML = "Not logged in";
            return;
        }

        let tokenResponse;

        try {
            tokenResponse = await msalInstance.acquireTokenSilent({
                scopes: [API_SCOPE],
                account
            });
        } catch (e) {
            // Silent failed â†’ redirect
            await msalInstance.acquireTokenRedirect({
                scopes: [API_SCOPE]
            });
            return;
        }

        console.log("ACCESS TOKEN:", tokenResponse.accessToken);

        const response = await fetch("/api/program-registrations", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${tokenResponse.accessToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                programId: "b196ed04-b32f-47ae-825b-543410b8133a"
            })
        });

        const text = await response.text();

        apiResult.innerHTML = response.ok
            ? `<pre>${text}</pre>`
            : `<pre>HTTP ${response.status}\n${text}</pre>`;
    };

    /* =========================================================
       LOGOUT
       ========================================================= */

    logoutBtn.onclick = () => {
        msalInstance.logoutRedirect({
            postLogoutRedirectUri: "http://localhost:8080"
        });
    };
</script>

</body>
</html>
