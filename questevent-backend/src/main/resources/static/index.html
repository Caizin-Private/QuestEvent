<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QuestEvent</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #user-section { display: none; }
        pre { background: #f4f4f4; padding: 12px; }
    </style>
</head>
<body>

<h1>QuestEvent</h1>

<div id="login-section">
    <button id="loginBtn">Login with Microsoft</button>
</div>

<div id="user-section">
    <h2>Welcome, <span id="user-name"></span>!</h2>
    <button id="apiBtn">Test API</button>
    <button id="logoutBtn">Logout</button>
    <div id="api-result"></div>
</div>

<script src="/js/msal-browser.min.js"></script>

<script>
    /* ================= MSAL CONFIG ================= */

    const msalConfig = {
        auth: {
            clientId: "8dfa7db6-153c-4137-91c7-4262f361c8c6",
            authority: "https://login.microsoftonline.com/f7b92ef4-239a-49ad-aff6-679ec33dea08",
            redirectUri: "https://questevent.online"
        },
        cache: {
            cacheLocation: "sessionStorage"
        }
    };

    const API_SCOPE = "api://8dfa7db6-153c-4137-91c7-4262f361c8c6/access_as_user";

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    /* ================= INIT (CRITICAL) ================= */

    (async () => {
        console.log("INITIALIZING MSAL");
        await msalInstance.initialize();

        console.log("HANDLING REDIRECT");
        const result = await msalInstance.handleRedirectPromise();
        console.log("REDIRECT RESULT:", result);

        if (result?.account) {
            msalInstance.setActiveAccount(result.account);
        } else {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                msalInstance.setActiveAccount(accounts[0]);
            }
        }

        updateUI();
    })();

    /* ================= UI ================= */

    const loginSection = document.getElementById("login-section");
    const userSection  = document.getElementById("user-section");
    const userName     = document.getElementById("user-name");
    const apiResult    = document.getElementById("api-result");

    function updateUI() {
        const account = msalInstance.getActiveAccount();
        console.log("ACTIVE ACCOUNT:", account);

        if (account) {
            loginSection.style.display = "none";
            userSection.style.display = "block";
            userName.textContent = account.name || account.username;
        } else {
            loginSection.style.display = "block";
            userSection.style.display = "none";
        }
    }

    /* ================= LOGIN ================= */

    loginBtn.onclick = () => {
        msalInstance.loginRedirect({
            scopes: ["openid", "profile", API_SCOPE]
        });
    };

    /* ================= API ================= */

    apiBtn.onclick = async () => {
        apiResult.textContent = "Calling API...";
        const account = msalInstance.getActiveAccount();

        const token = await msalInstance.acquireTokenSilent({
            scopes: [API_SCOPE],
            account
        });

        const res = await fetch("/api/leaderboard/global", {
            headers: {
                Authorization: `Bearer ${token.accessToken}`
            }
        });

        apiResult.innerHTML = `<pre>${await res.text()}</pre>`;
    };

    /* ================= LOGOUT ================= */

    logoutBtn.onclick = () => {
        msalInstance.logoutRedirect({
            postLogoutRedirectUri: "http://localhost:8080"
        });
    };
</script>

</body>
</html>
